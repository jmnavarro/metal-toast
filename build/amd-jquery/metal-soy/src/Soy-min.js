define(["exports","metal/src/metal","metal-component/src/all/component","html2incdom/src/withParser","metal-incremental-dom/src/IncrementalDomRenderer","./SoyAop","metal-soy-bundle/build/bundle"],function(t,e,n,o,r,a){"use strict";function i(t){return t&&t.__esModule?t:{"default":t}}function l(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function u(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function c(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(t,"__esModule",{value:!0}),t.SoyAop=t.Soy=void 0;var s=i(o),p=i(r),f=i(a),d=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),y=function g(t,e,n){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,e);if(void 0===o){var r=Object.getPrototypeOf(t);return null===r?void 0:g(r,e,n)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(n)},h={},m=function(t){function o(){return l(this,o),u(this,(o.__proto__||Object.getPrototypeOf(o)).apply(this,arguments))}return c(o,t),d(o,[{key:"addMissingStateKeys_",value:function(){var t=this.component_.constructor.TEMPLATE;if((0,e.isFunction)(t)){t=f["default"].getOriginalFn(t),this.soyParamTypes_=t.types||{};for(var n=t.params||[],o=this.component_,r=o.getDataManager().getStateInstance(),a=0;a<n.length;a++)r.hasStateKey(n[a])||o[n[a]]||r.addToState(n[a],{},o.getInitialConfig()[n[a]])}}},{key:"buildTemplateData_",value:function(t){var n=this,r=this.component_,a=e.object.mixin({},this.config_);r.getStateKeys().forEach(function(t){var e=r[t];n.isHtmlParam_(t)&&(e=o.toIncDom(e)),a[t]=e});for(var i=0;i<t.length;i++)!a[t[i]]&&(0,e.isFunction)(r[t[i]])&&(a[t[i]]=r[t[i]].bind(r));return a}},{key:"handleDataManagerCreated_",value:function(){y(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"handleDataManagerCreated_",this).call(this),this.addMissingStateKeys_()}},{key:"isHtmlParam_",value:function(t){var e=this.component_.getDataManager().getStateInstance();if(e.getStateKeyConfig(t).isHtml)return!0;var n=this.soyParamTypes_[t]||"";return n.split("|").indexOf("html")!==-1}},{key:"renderIncDom",value:function(){var t=this.component_.constructor.TEMPLATE;(0,e.isFunction)(t)&&!this.component_.render?(t=f["default"].getOriginalFn(t),f["default"].startInterception(o.handleInterceptedCall_),t(this.buildTemplateData_(t.params||[]),null,h),f["default"].stopInterception()):y(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"renderIncDom",this).call(this)}},{key:"shouldUpdate",value:function(){var t=y(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"shouldUpdate",this).call(this);if(!t||this.component_.shouldUpdate)return t;for(var e=this.component_.constructor.TEMPLATE,n=e?f["default"].getOriginalFn(e).params:[],r=0;r<n.length;r++)if(this.changes_[n[r]])return!0;return!1}}],[{key:"getTemplate",value:function(t,e){return function(n,o,r){if(!goog.loadedModules_[t])throw new Error('No template with namespace "'+t+'" has been loaded yet.');return goog.loadedModules_[t][e](n,o,r)}}},{key:"handleInterceptedCall_",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=[t.componentCtor,null,[]];for(var o in e)n.push(o,e[o]);IncrementalDOM.elementVoid.apply(null,n)}},{key:"register",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"render";t.RENDERER=o,t.TEMPLATE=f["default"].getOriginalFn(e[r]),t.TEMPLATE.componentCtor=t,f["default"].registerForInterception(e,r),n.ComponentRegistry.register(t)}},{key:"setInjectedData",value:function(t){h=t||{}}},{key:"toHtmlString",value:function(t){var e=document.createElement("div");return IncrementalDOM.patch(e,t),e.innerHTML}},{key:"toIncDom",value:function(t){return(0,e.isObject)(t)&&(0,e.isString)(t.content)&&"HTML"===t.contentKind&&(t=t.content),(0,e.isString)(t)&&(t=s["default"].buildFn(t)),t}}]),o}(p["default"]);m.RENDERER_NAME="soy",t["default"]=m,t.Soy=m,t.SoyAop=f["default"]});