define(["exports","metal/src/metal","metal-dom/src/all/dom","metal-component/src/all/component","./IncrementalDomAop","./children/IncrementalDomChildren","./cleanup/IncrementalDomUnusedComponents","./utils/IncrementalDomUtils","./incremental-dom"],function(e,t,n,r,o,i,a,l){"use strict";function d(e){return e&&e.__esModule?e:{"default":e}}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function h(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(e,"__esModule",{value:!0});var s=d(n),p=d(o),_=d(i),f=d(a),m=d(l),g=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),v=function b(e,t,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:b(o,t,n)}if("value"in r)return r.value;var i=r.get;if(void 0!==i)return i.call(n)},C=function(e){function n(e){u(this,n);var t=c(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return e.context={},t.setConfig_(e,e.getInitialConfig()),t.changes_={},e.on("attached",t.handleAttached_.bind(t)),t.component_.constructor.SYNC_UPDATES_MERGED||e.on("stateKeyChanged",t.handleStateKeyChanged_.bind(t)),t.handleInterceptedAttributesCall_=t.handleInterceptedAttributesCall_.bind(t),t.handleInterceptedOpenCall_=t.handleInterceptedOpenCall_.bind(t),t.handleChildrenCaptured_=t.handleChildrenCaptured_.bind(t),t.handleChildRender_=t.handleChildRender_.bind(t),t.renderInsidePatchDontSkip_=t.renderInsidePatchDontSkip_.bind(t),t}return h(n,e),g(n,[{key:"attachDecoratedListeners_",value:function(e,t){if(!this.component_.wasRendered)for(var n=(t[2]||[]).concat(t.slice(3)),r=0;r<n.length;r+=2){var o=this.getEventFromListenerAttr_(n[r]);o&&!e[o+"__handle__"]&&this.attachEvent_(e,n[r],o,n[r+1])}}},{key:"attachEvent_",value:function(e,n,r,o){var i=r+"__handle__";e[i]&&(e[i].removeListener(),e[i]=null),e[n]=o,o?(t.core.isString(o)&&("d"===n[0]&&e.setAttribute(n,o),o=this.component_.getListenerFn(o)),e[i]=s["default"].delegate(document,r,e,o)):e.removeAttribute(n)}},{key:"buildChildren_",value:function(e){return 0===e.length?R:e}},{key:"buildRef",value:function(e){var n=t.core.isString(e)?r.ComponentRegistry.getConstructor(e):e,o=this.currentPrefix_+t.core.getUid(n,!0),i=this.generatedRefCount_[o]||0;return this.generatedRefCount_[o]=i+1,o+"sub"+i}},{key:"getSubComponent_",value:function(e,n){var o=e;t.core.isString(o)&&(o=r.ComponentRegistry.getConstructor(e));var i=this.component_.components[n.ref];return i&&i.constructor!==o&&(i=null),i||(i=new o(n,(!1)),this.component_.addSubComponent(n.ref,i)),i.wasRendered&&(this.setConfig_(i,n),i.getRenderer().startSkipUpdates(),i.setState(n),i.getRenderer().stopSkipUpdates()),i}},{key:"guaranteeParent_",value:function(){var e=this.component_.element;if(!e||!e.parentNode){var t=document.createElement("div");return e&&s["default"].append(t,e),t}}},{key:"handleAttached_",value:function(e){this.attachData_=e}},{key:"handleInterceptedAttributesCall_",value:function(e,n,r,o){var i=this.getEventFromListenerAttr_(r);return i?void this.attachEvent_(n,r,i,o):("checked"===r&&(o=t.core.isDefAndNotNull(o)&&o!==!1),"value"===r&&n.value!==o&&(n[r]=o),void(t.core.isBoolean(o)?(n[r]=o,o?n.setAttribute(r,""):n.removeAttribute(r)):e(n,r,o)))}},{key:"handleChildrenCaptured_",value:function(e){var t=this.componentToRender_,n=t.config,r=t.tag;n.children=this.buildChildren_(e.config.children),this.componentToRender_=null,this.currentPrefix_=this.prevPrefix_,this.prevPrefix_=null,this.renderFromTag_(r,n)}},{key:"handleChildRender_",value:function(e){if(e.tag&&m["default"].isComponentTag(e.tag))return e.config.children=this.buildChildren_(e.config.children),this.renderFromTag_(e.tag,e.config),!0}},{key:"handleComponentRendererStateKeyChanged_",value:function(e){this.handleStateKeyChanged_(e),v(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"handleComponentRendererStateKeyChanged_",this).call(this,e)}},{key:"handleInterceptedOpenCall_",value:function(e,t){return m["default"].isComponentTag(t)?this.handleSubComponentCall_.apply(this,arguments):this.handleRegularCall_.apply(this,arguments)}},{key:"handleRegularCall_",value:function(e){for(var t=n.getComponentBeingRendered(),r=t.getRenderer(),o=arguments.length,i=Array(o>1?o-1:0),a=1;a<o;a++)i[a-1]=arguments[a];!r.rootElementReached_&&t.config.key&&(i[1]=t.config.key);var l=e.apply(null,i);return this.attachDecoratedListeners_(l,i),this.updateElementIfNotReached_(l),l}},{key:"handleStateKeyChanged_",value:function(e){this.changes_[e.key]=e}},{key:"handleSubComponentCall_",value:function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];var i=m["default"].buildConfigFromCall(r);i.ref=t.core.isDefAndNotNull(i.ref)?i.ref:this.buildRef(r[0]),this.componentToRender_={config:i,tag:r[0]},this.prevPrefix_=this.currentPrefix_,this.currentPrefix_=i.ref,this.generatedRefCount_[this.currentPrefix_]=0,_["default"].capture(this,this.handleChildrenCaptured_)}},{key:"intercept_",value:function(){p["default"].startInterception({attributes:this.handleInterceptedAttributesCall_,elementOpen:this.handleInterceptedOpenCall_})}},{key:"getEventFromListenerAttr_",value:function(e){var t=n.LISTENER_REGEX.exec(e),r=t?t[1]?t[1]:t[2]:null;return r?r.toLowerCase():null}},{key:"getParent",value:function(){return this.parent_}},{key:"getOwner",value:function(){return this.owner_}},{key:"render",value:function(){this.patch()}},{key:"renderChild",value:function(e){this.intercept_(),_["default"].render(e,this.handleChildRender_),p["default"].stopInterception()}},{key:"renderFromTag_",value:function(e,n){if(t.core.isString(e)||e.prototype.getRenderer){var r=this.renderSubComponent_(e,n);return this.updateElementIfNotReached_(r.element),r.element}return e(n)}},{key:"renderIncDom",value:function(){this.component_.render?this.component_.render():IncrementalDOM.elementVoid("div")}},{key:"renderInsidePatch",value:function(){return this.component_.wasRendered&&!this.shouldUpdate(this.changes_)&&IncrementalDOM.currentPointer()===this.component_.element?void(this.component_.element&&IncrementalDOM.skipNode()):void this.renderInsidePatchDontSkip_()}},{key:"renderInsidePatchDontSkip_",value:function(){n.startedRenderingComponent(this.component_),this.changes_={},this.rootElementReached_=!1,f["default"].schedule(this.childComponents_||[]),this.childComponents_=[],this.generatedRefCount_={},this.listenersToAttach_=[],this.currentPrefix_="",this.intercept_(),this.renderIncDom(),p["default"].stopInterception(),this.rootElementReached_?this.component_.addElementClasses():this.component_.element=null,this.emit("rendered",!this.isRendered_),n.finishedRenderingComponent()}},{key:"renderSubComponent_",value:function(e,t){var r=this.getSubComponent_(e,t);this.updateContext_(r);var o=r.getRenderer();if(o instanceof n){var i=n.getComponentBeingRendered();i.getRenderer().childComponents_.push(r),o.parent_=i,o.owner_=this.component_,o.renderInsidePatch()}return r.wasRendered||r.renderAsSubComponent(),r}},{key:"setConfig_",value:function(e,n){var r=e.config;e.config=n,t.core.isFunction(e.configChanged)&&e.configChanged(n,r||{}),e.emit("configChanged",{prevVal:r,newVal:n})}},{key:"shouldUpdate",value:function(e){return!this.component_.shouldUpdate||this.component_.shouldUpdate(e)}},{key:"patch",value:function(){if(!this.component_.element&&this.parent_)return void this.parent_.getRenderer().patch();var e=this.guaranteeParent_();if(e)IncrementalDOM.patch(e,this.renderInsidePatchDontSkip_),s["default"].exitDocument(this.component_.element),this.component_.element&&this.component_.inDocument&&this.component_.renderElement_(this.attachData_.parent,this.attachData_.sibling);else{var t=this.component_.element;IncrementalDOM.patchOuter(t,this.renderInsidePatchDontSkip_),this.component_.element||s["default"].exitDocument(t)}}},{key:"update",value:function(){this.hasChangedBesidesElement_(this.changes_)&&this.shouldUpdate(this.changes_)&&this.patch()}},{key:"updateElementIfNotReached_",value:function(e){var t=n.getComponentBeingRendered(),r=t.getRenderer();r.rootElementReached_||(r.rootElementReached_=!0,t.element!==e&&(t.element=e))}},{key:"updateContext_",value:function(e){var r=e.context,o=n.getComponentBeingRendered(),i=o.getChildContext?o.getChildContext():{};t.object.mixin(r,o.context,i),e.context=r}}],[{key:"getComponentBeingRendered",value:function(){return y[y.length-1]}},{key:"finishedRenderingComponent",value:function(){y.pop(),0===y.length&&f["default"].disposeUnused()}},{key:"isIncDomNode",value:function(e){return!!e[_["default"].CHILD_OWNER]}},{key:"render",value:function(e,t,o){if(!r.Component.isComponentCtor(e)){var i=e,a=function(e){function t(){return u(this,t),c(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return h(t,e),g(t,[{key:"created",value:function(){n.getComponentBeingRendered()&&this.getRenderer().updateContext_(this)}},{key:"render",value:function(){i(this.config)}}]),t}(r.Component);a.RENDERER=n,e=a}return r.Component.render(e,t,o)}},{key:"renderChild",value:function(e){e[_["default"].CHILD_OWNER].renderChild(e)}},{key:"startedRenderingComponent",value:function(e){y.push(e)}}]),n}(r.ComponentRenderer),y=[],R=[];C.LISTENER_REGEX=/^(?:on([A-Z]\w+))|(?:data-on(\w+))$/,e["default"]=C});