define(["exports","metal/src/metal","metal-dom/src/all/dom","./ComponentDataManager","./ComponentRenderer","metal-events/src/events"],function(e,t,n,r,a,i){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(e,"__esModule",{value:!0});var c=s(r),d=s(a),h=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),f=function v(e,t,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);if(void 0===r){var a=Object.getPrototypeOf(e);return null===a?void 0:v(a,t,n)}if("value"in r)return r.value;var i=r.get;if(void 0!==i)return i.call(n)},_=function(e){function r(e,n){o(this,r);var a=l(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return a.attachedListeners_={},a.components={},a.elementEventProxy_=null,a.eventsStateKeyHandler_=new i.EventHandler,a.inDocument=!1,a.initialConfig_=e||{},a.wasRendered=!1,a.DEFAULT_ELEMENT_PARENT=document.body,(0,t.mergeSuperClassesProperty)(a.constructor,"ELEMENT_CLASSES",a.mergeElementClasses_),(0,t.mergeSuperClassesProperty)(a.constructor,"SYNC_UPDATES",t.array.firstDefinedValue),a.element=a.initialConfig_.element,a.renderer_=a.createRenderer(),a.renderer_.on("rendered",a.handleRendererRendered_.bind(a)),a.dataManager_=a.createDataManager(),a.emit("dataManagerCreated"),a.on("stateChanged",a.handleStateChanged_),a.newListenerHandle_=a.on("newListener",a.handleNewListener_),a.on("eventsChanged",a.onEventsChanged_),a.addListenersFromObj_(a.dataManager_.get("events")),a.created(),a.componentCreated_=!0,n!==!1&&a.render_(n),a.on("elementChanged",a.onElementChanged_),a}return u(r,e),h(r,[{key:"addListenersFromObj_",value:function(e){for(var t=Object.keys(e||{}),n=0;n<t.length;n++){var r=this.extractListenerInfo_(e[t[n]]);if(r.fn){var a;a=r.selector?this.delegate(t[n],r.selector,r.fn):this.on(t[n],r.fn),this.eventsStateKeyHandler_.add(a)}}}},{key:"attach",value:function(e,t){return this.inDocument||(this.renderElement_(e,t),this.inDocument=!0,this.emit("attached",{parent:e,sibling:t}),this.attached()),this}},{key:"attached",value:function(){}},{key:"addSubComponent",value:function(e,t){this.components[e]=t}},{key:"created",value:function(){}},{key:"createDataManager",value:function(){return(0,t.mergeSuperClassesProperty)(this.constructor,"DATA_MANAGER",t.array.firstDefinedValue),new this.constructor.DATA_MANAGER_MERGED(this,r.DATA)}},{key:"createRenderer",value:function(){return(0,t.mergeSuperClassesProperty)(this.constructor,"RENDERER",t.array.firstDefinedValue),new this.constructor.RENDERER_MERGED(this)}},{key:"delegate",value:function(e,t,n){return this.on("delegate:"+e+":"+t,n)}},{key:"detach",value:function(){return this.inDocument&&(this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.inDocument=!1,this.detached()),this.emit("detached"),this}},{key:"detached",value:function(){}},{key:"disposed",value:function(){}},{key:"disposeInternal",value:function(){this.disposed(),this.detach(),this.elementEventProxy_&&(this.elementEventProxy_.dispose(),this.elementEventProxy_=null),this.disposeSubComponents(Object.keys(this.components)),this.components=null,this.dataManager_.dispose(),this.dataManager_=null,this.renderer_.dispose(),this.renderer_=null,f(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"disposeInternal",this).call(this)}},{key:"disposeSubComponents",value:function(e){for(var t=0;t<e.length;t++){var n=this.components[e[t]];n&&!n.isDisposed()&&(n.element=null,n.dispose(),delete this.components[e[t]])}}},{key:"extractListenerInfo_",value:function(e){var n={fn:e};return(0,t.isObject)(e)&&!(0,t.isFunction)(e)&&(n.selector=e.selector,n.fn=e.fn),(0,t.isString)(n.fn)&&(n.fn=this.getListenerFn(n.fn)),n}},{key:"getDataManager",value:function(){return this.dataManager_}},{key:"getInitialConfig",value:function(){return this.initialConfig_}},{key:"getListenerFn",value:function(e){if((0,t.isFunction)(this[e]))return this[e].bind(this)}},{key:"getState",value:function(){return this.dataManager_.getState()}},{key:"getStateKeys",value:function(){return this.dataManager_.getStateKeys()}},{key:"fireStateKeyChange_",value:function(e,n){var r=this["sync"+e.charAt(0).toUpperCase()+e.slice(1)];if((0,t.isFunction)(r)){if(!n){var a=this.getDataManager();n={newVal:a.get(e),prevVal:void 0}}r.call(this,n.newVal,n.prevVal)}}},{key:"getRenderer",value:function(){return this.renderer_}},{key:"handleRendererRendered_",value:function(e){this.rendered(e),this.emit("rendered",e)}},{key:"handleStateChanged_",value:function(e){this.syncStateFromChanges_(e.changes),this.emit("stateSynced",e)}},{key:"handleNewListener_",value:function(e){this.attachedListeners_[e]=!0}},{key:"mergeElementClasses_",value:function(e){var t={};return e.filter(function(e){return!(!e||t[e])&&(t[e]=!0,!0)}).join(" ")}},{key:"onElementChanged_",value:function(e){this.setUpProxy_(),this.elementEventProxy_.setOriginEmitter(e.newVal),e.newVal&&this.syncVisible(this.dataManager_.get("visible"))}},{key:"onEventsChanged_",value:function(e){this.eventsStateKeyHandler_.removeAllListeners(),this.addListenersFromObj_(e.newVal)}},{key:"render_",value:function(e,t){t||this.emit("render"),this.setUpProxy_(),this.syncState_(),this.attach(e),this.wasRendered=!0}},{key:"renderAsSubComponent",value:function(){this.render_(null,!0)}},{key:"renderElement_",value:function(e,t){var r=this.element;if(r&&(t||!r.parentNode)){var a=(0,n.toElement)(e)||this.DEFAULT_ELEMENT_PARENT;a.insertBefore(r,(0,n.toElement)(t))}}},{key:"setState",value:function(e,t){this.dataManager_.setState(e,t)}},{key:"setterElementClassesFn_",value:function(e){return this.constructor.ELEMENT_CLASSES_MERGED&&(e+=" "+this.constructor.ELEMENT_CLASSES_MERGED),e.trim()}},{key:"setUpProxy_",value:function(){if(!this.elementEventProxy_){var e=new n.DomEventEmitterProxy(this.element,this);this.elementEventProxy_=e,t.object.map(this.attachedListeners_,e.proxyEvent.bind(e)),this.attachedListeners_=null,this.newListenerHandle_.removeListener(),this.newListenerHandle_=null}}},{key:"syncState_",value:function(){for(var e=this.dataManager_.getSyncKeys(),t=0;t<e.length;t++)this.fireStateKeyChange_(e[t])}},{key:"syncStateFromChanges_",value:function(e){for(var t in e)this.fireStateKeyChange_(t,e[t])}},{key:"syncVisible",value:function(e){this.element&&(this.element.style.display=e?"":"none")}},{key:"rendered",value:function(){}},{key:"validatorEventsFn_",value:function(e){return!(0,t.isDefAndNotNull)(e)||(0,t.isObject)(e)}},{key:"element",get:function(){return this.elementVal_},set:function(e){if(((0,t.isElement)(e)||(0,t.isString)(e)||!(0,t.isDefAndNotNull)(e))&&(e&&(e=(0,n.toElement)(e)||this.elementVal_),this.elementVal_!==e)){var r=this.elementVal_;this.elementVal_=e,this.componentCreated_&&this.emit("elementChanged",{prevVal:r,newVal:e})}}}],[{key:"isComponentCtor",value:function(e){return e.prototype&&e.prototype[r.COMPONENT_FLAG]}},{key:"render",value:function(e,n,r){var a=n,i=r;(0,t.isElement)(n)&&(a=null,i=n);var s=new e(a,(!1));return s.render_(i),s}}]),r}(i.EventEmitter);_.DATA={elementClasses:{setter:"setterElementClassesFn_",validator:t.isString,value:""},events:{validator:"validatorEventsFn_",value:null},visible:{validator:t.isBoolean,value:!0}},_.COMPONENT_FLAG="__metal_component__",_.DATA_MANAGER=c["default"],_.ELEMENT_CLASSES="",_.RENDERER=d["default"],_.SYNC_UPDATES=!1,_.prototype[_.COMPONENT_FLAG]=!0,e["default"]=_});