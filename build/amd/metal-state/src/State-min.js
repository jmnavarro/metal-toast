define(["exports","metal/src/metal","metal-events/src/events"],function(t,e,a){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function r(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),o=function l(t,e,a){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,e);if(void 0===n){var i=Object.getPrototypeOf(t);return null===i?void 0:l(i,e,a)}if("value"in n)return n.value;var r=n.get;if(void 0!==r)return r.call(a)},u=function(t){function a(t){n(this,a);var e=i(this,(a.__proto__||Object.getPrototypeOf(a)).call(this));return e.scheduledBatchData_=null,e.stateInfo_={},e.setShouldUseFacade(!0),e.mergeInvalidKeys_(),e.addToStateFromStaticHint_(t),e}return r(a,t),s(a,[{key:"addKeyToState",value:function(t,e,a){this.buildKeyInfo_(t,e,a),Object.defineProperty(this,t,this.buildKeyPropertyDef_(t))}},{key:"addToState",value:function(t,a,n){if(e.core.isString(t))return this.addKeyToState(t,a,n);for(var i=a||{},r=Object.keys(t),s={},o=0;o<r.length;o++){var u=r[o];this.buildKeyInfo_(u,t[u],i[u]),s[u]=this.buildKeyPropertyDef_(u)}n!==!1&&Object.defineProperties(n||this,s)}},{key:"addToStateFromStaticHint_",value:function(t){var e=this.constructor,n=!1;a.mergeStateStatic(e)&&(n=e.prototype),this.addToState(e.STATE_MERGED,t,n)}},{key:"assertValidStateKeyName_",value:function(t){if(this.constructor.INVALID_KEYS_MERGED[t])throw new Error("It's not allowed to create a state key with the name \""+t+'".')}},{key:"buildKeyInfo_",value:function(t,e,n){this.assertValidStateKeyName_(t),this.stateInfo_[t]={config:e||{},initialValue:n,state:a.KeyStates.UNINITIALIZED}}},{key:"buildKeyPropertyDef_",value:function(t){return{configurable:!0,enumerable:!0,get:function(){return this.getStateKeyValue_(t)},set:function(e){this.setStateKeyValue_(t,e)}}}},{key:"callFunction_",value:function(t,a){return e.core.isString(t)?this[t].apply(this,a):e.core.isFunction(t)?t.apply(this,a):void 0}},{key:"callSetter_",value:function(t,e,a){var n=this.stateInfo_[t],i=n.config;return i.setter&&(e=this.callFunction_(i.setter,[e,a])),e}},{key:"callValidator_",value:function(t,e){var a=this.stateInfo_[t],n=a.config;if(n.validator){var i=this.callFunction_(n.validator,[e,t,this]);return i instanceof Error,i}return!0}},{key:"canSetState",value:function(t){var e=this.stateInfo_[t];return!e.config.writeOnce||!e.written}},{key:"disposeInternal",value:function(){o(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"disposeInternal",this).call(this),this.stateInfo_=null,this.scheduledBatchData_=null}},{key:"emitBatchEvent_",value:function(){if(!this.isDisposed()){var t=this.scheduledBatchData_;this.scheduledBatchData_=null,this.emit("stateChanged",t)}}},{key:"get",value:function(t){return this[t]}},{key:"getState",value:function(t){for(var e={},a=t||this.getStateKeys(),n=0;n<a.length;n++)e[a[n]]=this[a[n]];return e}},{key:"getStateKeyConfig",value:function(t){return(this.stateInfo_[t]||{}).config}},{key:"getStateKeys",value:function(){return Object.keys(this.stateInfo_)}},{key:"getStateKeyValue_",value:function(t){return this.initStateKey_(t),this.stateInfo_[t].value}},{key:"hasBeenSet",value:function(t){var e=this.stateInfo_[t];return e.state===a.KeyStates.INITIALIZED||e.initialValue}},{key:"hasStateKey",value:function(t){return!!this.stateInfo_[t]}},{key:"informChange_",value:function(t,e){if(this.shouldInformChange_(t,e)){var a={key:t,newVal:this[t],prevVal:e};this.emit(t+"Changed",a),this.emit("stateKeyChanged",a),this.scheduleBatchEvent_(a)}}},{key:"initStateKey_",value:function(t){var e=this.stateInfo_[t];e.state===a.KeyStates.UNINITIALIZED&&(e.state=a.KeyStates.INITIALIZING,this.setInitialValue_(t),e.written||(e.state=a.KeyStates.INITIALIZING_DEFAULT,this.setDefaultValue_(t)),e.state=a.KeyStates.INITIALIZED)}},{key:"mergeInvalidKeys_",value:function(){e.core.mergeSuperClassesProperty(this.constructor,"INVALID_KEYS",function(t){return e.array.flatten(t).reduce(function(t,e){return e&&(t[e]=!0),t},{})})}},{key:"removeStateKey",value:function(t){this.stateInfo_[t]=null,delete this[t]}},{key:"scheduleBatchEvent_",value:function(t){this.scheduledBatchData_||(e.async.nextTick(this.emitBatchEvent_,this),this.scheduledBatchData_={changes:{}});var a=t.key,n=this.scheduledBatchData_.changes;n[a]?n[a].newVal=t.newVal:n[a]=t}},{key:"set",value:function(t,e){this.hasStateKey(t)&&(this[t]=e)}},{key:"setDefaultValue_",value:function(t){var e=this.stateInfo_[t].config;void 0!==e.value?this[t]=e.value:this[t]=this.callFunction_(e.valueFn)}},{key:"setInitialValue_",value:function(t){var e=this.stateInfo_[t];void 0!==e.initialValue&&(this[t]=e.initialValue,e.initialValue=void 0)}},{key:"setState",value:function(t,e){var a=this;Object.keys(t).forEach(function(e){return a.set(e,t[e])}),e&&this.scheduledBatchData_&&this.once("stateChanged",e)}},{key:"setStateKeyValue_",value:function(t,e){if(this.canSetState(t)&&this.validateKeyValue_(t,e)){var n=this.stateInfo_[t];void 0===n.initialValue&&n.state===a.KeyStates.UNINITIALIZED&&(n.state=a.KeyStates.INITIALIZED);var i=this[t];n.value=this.callSetter_(t,e,i),n.written=!0,this.informChange_(t,i)}}},{key:"shouldInformChange_",value:function(t,n){var i=this.stateInfo_[t];return i.state===a.KeyStates.INITIALIZED&&(e.core.isObject(n)||n!==this[t])}},{key:"validateKeyValue_",value:function(t,e){var n=this.stateInfo_[t];return n.state===a.KeyStates.INITIALIZING_DEFAULT||this.callValidator_(t,e)}}],[{key:"mergeState_",value:function(t){return e.object.mixin.apply(null,[{}].concat(t.reverse()))}},{key:"mergeStateStatic",value:function(t){return e.core.mergeSuperClassesProperty(t,"STATE",a.mergeState_)}}]),a}(a.EventEmitter);u.INVALID_KEYS=["state","stateKey"],u.KeyStates={UNINITIALIZED:0,INITIALIZING:1,INITIALIZING_DEFAULT:2,INITIALIZED:3},t["default"]=u});